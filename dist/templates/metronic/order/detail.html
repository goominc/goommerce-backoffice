<div class="page-head">
  <div class="container">
    <div id="contentTitle"></div> <!-- commonly initialized -->
  </div>
</div>
<div class="page-content">
  <div class="container">
    <div id="breadcrumb"></div> <!-- commonly initialized -->
    <div class="page-content-inner">
      <div class="row">
        <div class="col-md-12">
          <div class="portlet light">
            <div class="portlet-title">
              {{order.id}}
              <div class="actions btn-set">
                <button class="btn red" ng-click="deleteOrder()"><i class="fa fa-exclamation-triangle"></i> {{'order.detail.deleteButton' | translate}}</button>
              </div>
            </div>
            <div class="portlet-body">
              <div class="row" data-ng-if="order.status === 100">
                <div class="col-md-12" style="margin-bottom: 20px;">
                  <button class="btn green" disabled>상품준비중</button> >
                  <button class="btn blue" data-ng-click="readyShipment()">
                    <i class="fa fa-check" /> 배송준비완료
                  </button> >
                  <button class="btn grey" disabled>배송중</button> >
                  <button class="btn grey" disabled>구매확정</button>
                </div>
                <div class="col-md-12" style="margin-bottom: 20px;">
                  <div class="alert alert-danger">
                    주문한 상품을 확인하고 준비한 뒤 <b>배송준비완료</b> 버튼을 클릭하세요
                  </div>
                </div>
              </div>
              <div class="row" data-ng-if="order.status === 102">
                <div class="col-md-12">
                  <button class="btn green" disabled>상품준비중</button> >
                  <button class="btn green" disabled>배송준비완료</button> >
                  <button class="btn blue" ng-click="startShipment()">
                    <i class="fa fa-check" /> 배송중
                  </button> >
                  <button class="btn grey" disabled>구매확정</button>
                </div>
                <div class="col-md-12" style="margin: 15px 5px;">
                  <div class="col-md-4">
                    <input
                      class="form-control"
                      type="text"
                      placeholder="송장번호 입력해 주세요"
                      data-ng-model="newShipment.trackingNumber"
                    />
                  </div>
                  <div class="col-md-2">
                    <select class="form-control" data-ng-model="newShipment.provider" convert-to-number>
                      <option value="1" ng-if="order.address.countryCode === 'KR'">로젝택배</option>
                      <option value="0" ng-if="order.address.countryCode === 'KR'">CJ</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-12" style="margin-bottom: 20px;">
                  <div class="alert alert-danger">
                    송장 번호를 입력한 후 <b>배송 중</b> 버튼을 클릭하세요
                  </div>
                </div>
              </div>
              <div class="row" data-ng-if="order.status === 200">
                <div class="col-md-12" style="margin: 15px 0;">
                  <button class="btn green" disabled>상품준비중</button> >
                  <button class="btn green" disabled>배송준비완료</button> >
                  <button class="btn green" disabled>배송중</button> >
                  <button class="btn blue" ng-click="closeOrder()">
                    <i class="fa fa-check" /> 구매확정
                  </button>
                </div>
                <div class="col-md-12" style="margin-bottom: 20px;">
                  <div class="alert alert-danger">
                    구매 확정 버튼을 눌러 주세요. 고객에게 마일리지가 부여됩니다.
                  </div>
                </div>
              </div>
              <div class="row" data-ng-if="order.status === 400">
                <div class="col-md-12" style="margin: 15px 0;">
                  <button class="btn green" disabled>상품준비중</button> >
                  <button class="btn green" disabled>배송준비완료</button> >
                  <button class="btn green" disabled>배송중</button> >
                  <button class="btn green" disabled>구매확정</button>
                </div>
                <div class="alert">구매 완료된 주문입니다.</div>
              </div>
              <div class="row">
                <div class="col-md-4">
                  <div class="portlet yellow-crusta box">
                    <div class="portlet-title">
                      <div class="caption">
                        <i class="fa fa-cogs"></i>주문 상세 정보
                      </div>
                      <div class="actions btn-set">
                        <button class="btn blue" ng-click="saveStatus()"><i class="fa fa-check"></i> {{'order.detail.saveButton' | translate}}</button>
                      </div>
                    </div>
                    <div class="portlet-body">
                      <div class="row static-info">
                        <div class="col-md-5 name">
                          Order #:
                        </div>
                        <div class="col-md-7 value">
                          {{order.id}} <!--span class="label label-info label-sm">Email confirmation was sent </span-->
                        </div>
                      </div>
                      <div class="row static-info">
                        <div class="col-md-5 name">
                          결제완료 시각:
                        </div>
                        <div class="col-md-7 value">
                          {{order.orderedAt}}
                        </div>
                      </div>
                      <div class="row static-info">
                        <div class="col-md-5 name">
                          주문 상태:
                        </div>
                        <div class="col-md-7 value">
                          <div class="form-group">
                            <select class="form-control" id="sel1" data-ng-model="order.status" convert-to-number>
                              <option data-ng-repeat="s in allStatus" value="{{s}}">{{translateOrderStatus(s)}}</option>
                            </select>
                          </div>
                        </div>
                      </div>
                      <div class="row static-info">
                        <div class="col-md-5 name">
                          결제 상태:
                        </div>
                        <div class="col-md-7 value">
                          <div class="form-group">
                            <select class="form-control" data-ng-model="order.paymentStatus" convert-to-number>
                              <option data-ng-repeat="p in allPaymentStatus" value="{{p}}">{{translateOrderPaymentStatus(p)}}</option>
                            </select>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="portlet blue-hoki box">
                    <div class="portlet-title">
                      <div class="caption">
                        <i class="fa fa-cogs"></i>고객 정보
                      </div>
                    </div>
                    <div class="portlet-body">
                      <div class="row static-info">
                        <div class="col-md-5 name">
                          유저 이름:
                        </div>
                        <div class="col-md-7 value">
                          {{user.name}}
                        </div>
                      </div>
                      <div class="row static-info">
                        <div class="col-md-5 name">
                          주문자 아이디:
                        </div>
                        <div class="col-md-7 value">
                          <a ui-sref="user.info({userId: user.id})">{{user.userId}}</a>
                        </div>
                      </div>
                      <div class="row static-info">
                        <div class="col-md-5 name">
                          전화번호:
                        </div>
                        <div class="col-md-7 value">
                          {{user.data.tel}}
                        </div>
                      </div>
                      <div class="row static-info" data-ng-if="user.data.bizImage.url">
                        <div class="col-md-12">
                          <a target="_blank" data-ng-if="user.data.bizImage.url" href="{{user.data.bizImage.url}}">
                            <img width="100%" data-ng-src="{{user.data.bizImage.url}}" />
                          </a>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="portlet red-sunglo box">
                    <div class="portlet-title">
                      <div class="caption">
                        <i class="fa fa-cogs"></i>배송 주소
                      </div>
                    </div>
                    <div class="portlet-body">
                      <div class="row static-info">
                        <div class="col-md-12 value">
                          <div data-ng-repeat="field in addressFields">{{field.title}}: {{field.obj}}</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-12">
                  <div class="portlet yellow-crusta box">
                    <div class="portlet-title">
                      <div class="caption">
                        <i class="fa fa-cogs"></i>항목별 상세내역
                      </div>
                    </div>
                    <div class="portlet-body">
                      <div class="row static-info">
                        <div class="col-md-3 name">
                        </div>
                        <div class="col-md-3 value">
                          original
                        </div>
                        <div class="col-md-3 value">
                          final
                        </div>
                        <div class="col-md-3 value">
                          diff
                        </div>
                      </div>
                      <div class="row static-info">
                        <div class="col-md-3 name">
                          상품가격:
                        </div>
                        <div class="col-md-3 value">
                          {{(+order.subtotalKRW).format()}} 원
                        </div>
                        <div class="col-md-3 value">
                          {{(+order.finalSubtotalKRW).format()}} 원
                        </div>
                        <div class="col-md-3 value">
                          {{(order.subtotalKRW - order.finalSubtotalKRW).format()}} 원
                        </div>
                      </div>
                      <div class="row static-info">
                        <div class="col-md-3 name">
                          배송비:
                        </div>
                        <div class="col-md-3 value">
                          {{(+order.shippingCostKRW).format()}} 원
                        </div>
                        <div class="col-md-3 value">
                          {{(+order.finalShippingCostKRW).format()}} 원
                        </div>
                        <div class="col-md-3 value">
                          {{(order.shippingCostKRW - order.finalShippingCostKRW).format()}} 원
                        </div>
                      </div>
                      <div class="row static-info">
                        <div class="col-md-3 name">
                          쿠폰할인 금액:
                        </div>
                        <div class="col-md-3 value">
                          {{(-order.couponKRW || 0).format()}} 원
                        </div>
                        <div class="col-md-3 value">
                          {{(-order.couponKRW || 0).format()}} 원
                        </div>
                        <div class="col-md-3 value">
                          -
                        </div>
                      </div>
                      <div class="row static-info">
                        <div class="col-md-3 name">
                          총 금액:
                        </div>
                        <div class="col-md-3 value">
                          {{(+order.totalKRW + (+order.credit || 0)).format()}} 원
                        </div>
                        <div class="col-md-3 value">
                          {{(+order.finalTotalKRW + (+order.credit || 0)).format()}} 원
                        </div>
                        <div class="col-md-3 value">
                          {{(order.totalKRW - order.finalTotalKRW).format()}} 원
                        </div>
                      </div>
                      <div class="row static-info">
                        <div class="col-md-3 name">
                          마일리지 사용 금액:
                        </div>
                        <div class="col-md-3 value">
                          {{(-order.credit || 0).format()}} 원
                        </div>
                        <div class="col-md-3 value">
                          {{(-order.credit || 0).format()}} 원
                        </div>
                        <div class="col-md-3 value">
                          -
                        </div>
                      </div>
                      <div class="row static-info">
                        <div class="col-md-3 name">
                          결제 금액:
                        </div>
                        <div class="col-md-3 value">
                          {{(+order.totalPaid.amount).format()}} 원
                        </div>
                        <div class="col-md-3 value">
                          {{(+order.finalTotalKRW).format()}} 원
                        </div>
                        <div class="col-md-3 value">
                          {{(order.totalPaid.amount - order.finalTotalKRW - order.totalRefuned).format()}} ({{(+order.totalRefuned).format()}})
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-12">
                  <div class="portlet grey-cascade box">
                    <div class="portlet-title">
                      <div class="caption">
                        <i class="fa fa-cogs"></i>배송 정보
                      </div>
                    </div>
                    <div class="portlet-body">
                      <div class="table-responsive">
                        <table class="table table-hover table-bordered table-striped">
                          <thead>
                            <tr>
                              <th width="15%">배송일자</th>
                              <th width="10%">배송업체</th>
                              <th width="10%">배송비/KG</th>
                              <th width="10%">KG</th>
                              <th width="10%">BOX</th>
                              <th width="10%">총 배송비</th>
                              <th width="25%">송장번호</th>
                              <th width="10%"></th>
                            </tr>
                            <tr>
                              <th>
                                <select class="form-control" data-ng-model="newShipment.startDate">
                                  <option data-ng-repeat="date in getDates(10)">{{date}}</option>
                                </select>
                              </th>
                              <th>
                                <select class="form-control" data-ng-model="newShipment.provider" convert-to-number>
                                  <option value="1" ng-if="order.address.countryCode === 'KR'">로젝택배</option>
                                  <option value="0" ng-if="order.address.countryCode === 'KR'">CJ</option>
                                  <option value="104" ng-if="order.address.countryCode !== 'KR'">영통</option>
                                  <option value="105" ng-if="order.address.countryCode !== 'KR'">판다</option>
                                </select>
                              </th>
                              <th><input class="form-control" string-to-number data-ng-model="newShipment.unitKRW"/></th>
                              <th><input class="form-control" data-ng-model="newShipment.weight"/></th>
                              <th><input class="form-control" string-to-number data-ng-model="newShipment.boxKRW"/></th>
                              <th>{{calcShipmentTotal(newShipment || {})}}</th>
                              <th><input class="form-control" data-ng-model="newShipment.trackingNumber"/></th>
                              <th>
                                <button class="btn blue" data-ng-click="addShipment(newShipment)">
                                  <i class="fa fa-plus"></i> 추가
                                </button>
                              </th>
                            </tr>
                          </thead>
                          <tbody class="cell-center">
                            <tr data-ng-repeat="row in order.shipments">
                              <td>{{row.startDate.substr(0, 10)}}</td>
                              <td>{{shipmentProviderText(row.provider)}}</td>
                              <td>{{row.unitKRW}}</td>
                              <td>{{row.weight}}</td>
                              <td>{{row.boxKRW}}</td>
                              <td>{{row.totalKRW}}</td>
                              <td>{{row.trackingNumber}}</td>
                              <td>
                                <button class="btn blue" data-ng-click="updateShipment(row)">
                                  <i class="fa fa-check"></i> 저장
                                </button>
                              </td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-12">
                  <div class="portlet grey-cascade box">
                    <div class="portlet-title">
                      <div class="caption">
                        <i class="fa fa-cogs"></i>주문 수정
                      </div>
                      <div class="actions btn-set">
                        <button class="btn blue" ng-click="finalize()"><i class="fa fa-check"></i> {{'order.detail.saveButton' | translate}}</button>
                      </div>
                    </div>
                    <div class="portlet-body">
                      <span>예상 배송비: {{order.shippingCostKRW}}, </span>
                      <label class="control-label">최종 배송비</label>
                      <input type="number" data-ng-model="order.finalShippingCostKRW" />
                      <p>상품 목록</p>
                      <div class="table-responsive">
                        <table class="table table-hover table-bordered table-striped">
                          <thead>
                          <tr>
                            <th>상품ID</th>
                            <th>이미지</th>
                            <th>품번</th>
                            <th>상품명</th>
                            <th>색상</th>
                            <th>크기</th>
                            <th>주문(최초) 가격</th>
                            <th>주문(최초) 수량</th>
                            <th>주문금액</th>
                            <th>최종수량</th>
                            <th>최종금액</th>
                          </tr>
                          </thead>
                          <tbody class="cell-center">
                          <tr data-ng-repeat="row in order.orderProducts">
                            <td>
                              <a href="/products/{{row.product.id}}" target="_blank">{{row.product.shortId}}</a>
                            </td>
                            <td>
                              <a href="/products/{{row.product.id}}" target="_blank">
                                <img width="80" ng-src="{{row.imageUrl}}" />
                              </a>
                            </td>
                            <td>
                              {{row.product.sku}}
                            </td>
                            <td>
                              {{row.product.name.ko}}
                            </td>
                            <td>
                              {{row.productVariant.data.color}}
                            </td>
                            <td>
                              {{row.productVariant.data.size}}
                            </td>
                            <td>
                              <span>{{(+row.productVariant.KRW).format()}}</span>
                            </td>
                            <td>
                              {{row.quantity}}
                            </td>
                            <td>
                              {{(+row.totalKRW).format()}}
                            </td>
                            <td>
                              <input type="number" data-ng-model="row.finalQuantity">
                            </td>
                            <td>
                              {{(+row.finalTotalKRW).format()}}
                            </td>
                          </tr>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-12">
                  <div class="portlet grey-cascade box">
                    <div class="portlet-title">
                      <div class="caption">
                        <i class="fa fa-cogs"></i>Payments
                      </div>
                    </div>
                    <div class="portlet-body">
                      <div class="table-responsive">
                        <table class="table table-hover table-bordered table-striped">
                          <thead>
                          <tr>
                            <th width="5%">ID</th>
                            <th width="5%">PID</th>
                            <th width="30%">TID / 메세지</th>
                            <th width="5%">Type</th>
                            <th width="10%">가격</th>
                            <th width="5%">통화</th>
                            <th width="5%">Method</th>
                            <th width="5%">상태</th>
                            <th width="5%">요청자</th>
                            <th width="10%">시간</th>
                            <th width="5%"></th>
                            <th width="5%"></th>
                          </tr>
                          </thead>
                          <tbody class="cell-center">
                          <tr data-ng-repeat="row in order.payments">
                            <td>
                              {{row.id}}
                            </td>
                            <td>
                              {{row.parentId}}
                            </td>
                            <td>
                              {{row.tid}}<br/>{{row.data.ResultMsg}}
                            </td>
                            <td>
                              {{translatePaymentType(row.type)}}
                            </td>
                            <td>
                              {{paymentAmount(row).format()}}
                            </td>
                            <td>
                              {{row.data.currency}}
                            </td>
                            <td>
                              {{row.data.payMethod || row.data.P_TYPE || row.data.paymethod}}
                            </td>
                            <td>
                              {{translatePaymentStatus(row.status)}}
                            </td>
                            <td>
                              {{paymentLogs[row.id][0].requester.name.ko || paymentLogs[row.id][0].requester.email}}
                            </td>
                            <td>
                              {{paymentLogs[row.id][0].createdAt}}
                            </td>
                            <td>
                              <div ng-if="row.type === 0">
                                <button class="btn blue" data-ng-click="popupRefund(row)">
                                  <i class="fa fa-eject"></i> 환불
                                </button>
                              </div>
                            </td>
                            <td>
                              <div ng-if="row.type === 0 && paymentMethod(row) === 'CARD'">
                                <form action="https://iniweb.inicis.com/app/publication/apReceipt.jsp" accept-charset="euc-kr" target="_blank">
                                  <input type="hidden" name="noTid" value="{{row.tid}}" />
                                  <input type="hidden" name="noMethod" value="1" />
                                  <input type="hidden" name="clpaymethod" value="0" />
                                  <input type="hidden" name="rt" value="1" />
                                  <input type="hidden" name="valFlg" value="1" />
                                  <input type="hidden" name="nmBuyer" value="{{row.data.P_UNAME || row.data.buyerName}}" />
                                  <input type="hidden" name="prGoods" value="{{row.data.P_AMT || row.data.TotPrice}}" />
                                  <button class="btn blue">
                                    <i class="fa fa-eject"></i> 영수증
                                  </button>
                                </form>
                              </div>
                              <div ng-if="row.type === 0 && paymentMethod(row) === 'VBANK'">
                                <form action="https://iniweb.inicis.com/app/publication/apCashReceipt.jsp" accept-charset="euc-kr" target="_blank">
                                  <input type="hidden" name="noTid" value="{{getParent(row).tid || row.tid}}" />
                                  <input type="hidden" name="noMethod" value="1" />
                                  <input type="hidden" name="clpaymethod" value="22" />
                                  <input type="hidden" name="rt" value="1" />
                                  <input type="hidden" name="valFlg" value="1" />
                                  <input type="hidden" name="nmBuyer" value="{{row.data.P_UNAME || getParent(row).data.buyerName}}" />
                                  <input type="hidden" name="prGoods" value="{{row.data.P_AMT || getParent(row).data.TotPrice}}" />
                                  <button class="btn blue">
                                    <i class="fa fa-eject"></i> 영수증
                                  </button>
                                </form>
                              </div>
                            </td>
                          </tr>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-12">
                  <div class="portlet grey-cascade box">
                    <div class="portlet-title">
                      <div class="caption">
                        <i class="fa fa-cogs"></i>NOTES
                      </div>
                    </div>
                    <div class="portlet-body">
                      <div class="table-responsive">
                        <table class="table table-hover table-bordered table-striped">
                          <thead>
                            <tr>
                              <th colspan="2"><input class="form-control" data-ng-model="newNote"/></th>
                              <th width="10%">
                                <button class="btn blue" data-ng-click="addNote(newNote)">
                                  <i class="fa fa-plus"></i> 추가
                                </button>
                              </th>
                            </tr>
                            <tr>
                              <th width="10%">시간</th>
                              <th width="70%">메세지</th>
                              <th width="10%">요청자</th>
                            </tr>
                          </thead>
                          <tbody class="cell-center">
                          <tr data-ng-repeat="row in notes">
                            <td>
                              {{row.createdAt}}
                            </td>
                            <td>
                              {{row.data.message}}
                            </td>
                            <td>
                              {{row.requester.name.ko || row.requester.email}}
                            </td>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="order_refund_modal">
  <div class="modal-dialog">
    <div class="modal-content">
      <form data-ng-submit="refund(refundPayment, refundAmount, refundAccountNumber, refundAccountHolder, refundBankCode)">
        <div class="modal-header">
          {{'order.detail.refundTitle' | translate}}
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-12 form-group">
              <label class="control-label">환불 가능 금액: {{(paymentAmount(refundPayment) - refundedAmount(refundPayment)).format()}} </label>
              <input class="form-control" type="number" min="1" max="{{(paymentAmount(refundPayment) - refundedAmount(refundPayment))|| 1}}" data-ng-model="refundAmount" placeholder="환불 금액을 입력하세요" />
              <div ng-show="paymentMethod(refundPayment) === 'VBANK'">
                <label class="control-label">환불 계좌번호</label>
                <input class="form-control" data-ng-model="refundAccountNumber" placeholder="환불 계좌번호를 입력하세요" />
                <label class="control-label">환불 계좌주명</label>
                <input class="form-control" data-ng-model="refundAccountHolder" placeholder="환불 계좌주명을 입력하세요" />
                <label class="control-label">환불 은행</label>
              	<select class="form-control" data-ng-model="refundBankCode">
                  <option value="">[선택]</option>
                  <option value="02">산업</option>
                  <option value="03">기업</option>
                  <option value="04">국민</option>
                  <option value="05">외환</option>
                  <option value="06">국민(주택)</option>
                  <option value="07">수협</option>
                  <option value="11">농협</option>
                  <option value="12">농협</option>
                  <option value="16">농협(축협)</option>
                  <option value="20">우리</option>
                  <option value="21">조흥</option>
                  <option value="23">제일</option>
                  <option value="25">서울</option>
                  <option value="26">신한</option>
                  <option value="27">한미</option>
                  <option value="31">대구</option>
                  <option value="32">부산</option>
                  <option value="34">광주</option>
                  <option value="35">제주</option>
                  <option value="37">전북</option>
                  <option value="38">강원</option>
                  <option value="39">경남</option>
                  <option value="41">비씨</option>
                  <option value="45">새마을</option>
                  <option value="48">신협</option>
                  <option value="50">상호저축은행</option>
                  <option value="53">씨티</option>
                  <option value="54">홍콩상하이은행</option>
                  <option value="55">도이치</option>
                  <option value="56">ABN암로</option>
                  <option value="70">신안상호</option>
                  <option value="71">우체국</option>
                  <option value="81">하나</option>
                  <option value="87">신세계</option>
                  <option value="88">신한</option>
                </select>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn default" type="reset" data-ng-click="closePopup()">{{'main.closeButton' | translate}}</button>
          <button class="btn blue" type="submit"><i class="fa fa-plus"></i> {{'main.saveButton' | translate}}</button>
        </div>
      </form>
    </div>
  </div>
</div>
<div class="modal fade" id="user_biz_image">
  <div class="modal-dialog">
    <div class="modal-content">
      <img width="600" data-ng-src="{{user.data.bizImage.url}}" />
    </div>
  </div>
</div>
